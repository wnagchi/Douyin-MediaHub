# 实施计划：前端请求缓存

## 概述

本实施计划涵盖了为抖音媒体画廊应用开发一个全面的前端缓存系统，使用 Web Workers 和 IndexedDB。该系统将持久化缓存 API 响应，减少网络流量，并支持离线浏览功能。

## 任务

- [x] 1. 搭建 IndexedDB 架构和缓存基础设施
  - 创建 IndexedDB 架构定义，包含缓存存储和索引
  - 定义缓存条目和记录的 TypeScript 接口
  - 设置缓存版本常量
  - _需求: 2.1, 2.4, 10.1, 10.5_

- [ ] 2. 实现带 IndexedDB 操作的缓存 Worker
  - [x] 2.1 创建 Web Worker 文件和消息处理基础设施
    - 设置 worker 消息协议（init, get, set, delete, clear, invalidate, stats, cleanup）
    - 实现消息 ID 跟踪以关联请求和响应
    - 添加错误处理和响应发送
    - _需求: 1.1, 1.2, 1.3, 1.4_

  - [ ] 2.2 实现 IndexedDB 初始化和连接管理
    - 打开或创建带架构的 IndexedDB
    - 处理数据库升级和迁移
    - 实现版本检查和不兼容条目清理
    - _需求: 2.1, 2.4, 10.2, 10.3_

  - [ ] 2.3 在 worker 中实现缓存 CRUD 操作
    - 实现 get 操作（按缓存键查询）
    - 实现 set 操作（存储带时间戳和版本的条目）
    - 实现 delete 操作（按键删除）
    - 实现 clear 操作（删除所有条目）
    - _需求: 2.2, 2.3_

  - [ ] 2.4 实现按模式的缓存失效
    - 按端点索引查询条目
    - 过滤匹配正则表达式模式的条目
    - 批量删除匹配的条目
    - _需求: 6.1, 6.2, 6.3, 6.4_

  - [ ] 2.5 实现存储配额管理
    - 计算总存储大小
    - 检测配额超限错误
    - 实现 LRU 清理（删除最旧的条目）
    - _需求: 2.5_

  - [ ] 2.6 实现缓存统计收集
    - 统计总条目数
    - 计算存储大小
    - 按端点分组统计
    - 在响应消息中返回统计信息
    - _需求: 8.3_

- [ ] 3. 实现主线程协调的缓存管理器
  - [ ] 3.1 创建带 worker 生命周期管理的 CacheManager 类
    - 从 worker 文件路径初始化 Web Worker
    - 设置消息发送和响应处理
    - 实现基于 Promise 的消息关联
    - 添加清理时的 worker 终止
    - _需求: 1.1, 1.2, 1.3, 1.5_

  - [ ] 3.2 实现缓存键生成算法
    - 规范化查询参数（删除 null/undefined，排序键）
    - 从端点和参数生成确定性哈希
    - 包含分页参数（page, pageSize）
    - 包含过滤参数（type, dirId, tags, search）
    - 确保相同请求生成相同的键
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ] 3.3 实现带过期检查的缓存 get 操作
    - 向 worker 发送 get 消息
    - 从 worker 接收缓存条目
    - 检查条目时间戳与过期阈值
    - 如果过期或缺失则返回 null
    - _需求: 3.5, 5.2, 5.3, 5.4_

  - [ ] 3.4 实现缓存 set 操作
    - 向 worker 发送带数据和时间戳的 set 消息
    - 在条目中包含缓存版本
    - 处理 worker 响应
    - _需求: 2.2, 5.1, 10.1_

  - [ ] 3.5 实现缓存失效方法
    - 实现按模式失效（正则表达式）
    - 实现 invalidateAll（清除所有条目）
    - 向 worker 发送失效消息
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [ ] 3.6 实现缓存统计跟踪
    - 在内存中跟踪命中和未命中
    - 计算命中率
    - 从 worker 获取存储统计
    - 提供 resetStats 方法
    - _需求: 8.1, 8.2, 8.3_

  - [ ] 3.7 配置每个端点的过期阈值
    - 定义阈值常量（resources: 5分钟, authors/tags: 15分钟, config: 1小时）
    - 实现 getStaleThreshold 辅助函数
    - 允许自定义阈值覆盖
    - _需求: 5.5_

- [ ] 4. 实现请求去重器
  - [ ] 4.1 创建 RequestDeduplicator 类
    - 按缓存键跟踪进行中的请求
    - 实现重用待处理 Promise 的 deduplicate 方法
    - 从跟踪映射中清除已完成的请求
    - 处理成功和失败情况
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [ ] 5. 实现缓存失效服务
  - [ ] 5.1 创建 InvalidationService 类
    - 在构造函数中接受 CacheManager
    - 定义失效规则模式
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 5.2 实现失效触发方法
    - 实现 onReindex（使 resources、authors、tags 失效）
    - 实现 onConfigUpdate（使 config 失效）
    - 实现 onMediaDelete（使 resources 和特定媒体失效）
    - 实现 onManualClear（清除所有缓存）
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 6. 增强 API 客户端的缓存集成
  - [ ] 6.1 初始化 CacheManager 和支持服务
    - 创建带配置的 CacheManager 实例
    - 创建 RequestDeduplicator 实例
    - 创建 InvalidationService 实例
    - 导出实例供 API 函数使用
    - _需求: 11.1, 11.3_

  - [ ] 6.2 实现 cachedFetch 包装函数
    - 检查缓存启用标志和 forceRefresh 选项
    - 从 URL 和参数生成缓存键
    - 检查缓存中的现有条目
    - 如果新鲜则返回缓存数据
    - 如果缓存未命中或过期则从网络获取
    - 用新数据更新缓存
    - 返回带缓存元数据的响应（cached, stale, timestamp）
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 11.2, 11.4_

  - [ ] 6.3 将去重集成到 cachedFetch
    - 用去重器包装网络请求
    - 使用缓存键作为去重键
    - 确保并发请求共享单个网络调用
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ] 6.4 更新 fetchResources 以使用 cachedFetch
    - 添加 RequestOptions 参数
    - 使用 resources 端点调用 cachedFetch
    - 返回带元数据的 CachedResponse
    - _需求: 3.1, 11.1, 11.2, 12.1, 12.2, 12.4_

  - [ ] 6.5 更新 fetchAuthors 以使用 cachedFetch
    - 添加 RequestOptions 参数
    - 使用 authors 端点调用 cachedFetch
    - 返回带元数据的 CachedResponse
    - _需求: 3.2, 11.1, 11.2_

  - [ ] 6.6 更新 fetchTags 以使用 cachedFetch
    - 添加 RequestOptions 参数
    - 使用 tags 端点调用 cachedFetch
    - 返回带元数据的 CachedResponse
    - _需求: 3.3, 11.1, 11.2_

  - [ ] 6.7 更新 fetchConfig 以使用 cachedFetch
    - 添加 RequestOptions 参数
    - 使用 config 端点调用 cachedFetch
    - 返回带元数据的 CachedResponse
    - _需求: 3.4, 11.1, 11.2_

- [ ] 7. 实现离线支持
  - [ ] 7.1 添加在线/离线检测
    - 检查 navigator.onLine 状态
    - 监听 online/offline 事件
    - 更新离线状态
    - _需求: 7.1, 7.2_

  - [ ] 7.2 修改 cachedFetch 以处理离线模式
    - 离线时返回缓存数据，无论是否过期
    - 无缓存时返回带离线指示的错误
    - 离线返回旧缓存数据时标记为过期
    - _需求: 7.1, 7.2, 7.4_

  - [ ] 7.3 实现重新连接时的后台缓存刷新
    - 监听 online 事件
    - 识别过期的缓存条目
    - 在后台刷新过期条目
    - _需求: 7.3, 7.5_

- [ ] 8. 实现分页缓存策略
  - [ ] 8.1 增强分页的缓存键生成
    - 在缓存键中包含页码
    - 在缓存键中包含 pageSize
    - 确保每页单独缓存
    - _需求: 12.1, 12.2_

  - [ ] 8.2 实现总数变化检测
    - 在分页响应中存储总数
    - 比较新总数与缓存总数
    - 总数变化时使所有页面失效
    - _需求: 12.3_

  - [ ] 8.3 实现过滤器变化检测
    - 在缓存键中包含所有过滤参数
    - 将不同过滤器视为单独的查询
    - _需求: 12.5_

- [ ] 9. 添加缓存监控和调试
  - [ ] 9.1 实现开发模式日志
    - 添加 enableLogging 配置选项
    - 记录缓存命中、未命中和操作
    - 在开发模式下记录 worker 消息
    - _需求: 8.5_

  - [ ] 9.2 添加缓存操作的错误日志
    - 记录 IndexedDB 错误
    - 记录 worker 通信错误
    - 记录配额超限错误
    - _需求: 8.4_

  - [ ] 9.3 创建缓存统计 API 端点（可选）
    - 暴露 getStats 方法
    - 返回命中率、条目数、存储大小
    - 按端点分组统计
    - _需求: 8.3_

- [ ] 10. 将缓存失效与 UI 操作集成
  - [ ] 10.1 将缓存失效挂钩到重新索引操作
    - 触发重新索引时调用 invalidationService.onReindex()
    - 失效后刷新 UI
    - _需求: 6.1, 6.5_

  - [ ] 10.2 将缓存失效挂钩到配置更新
    - 保存配置时调用 invalidationService.onConfigUpdate()
    - 失效后刷新 UI
    - _需求: 6.2, 6.5_

  - [ ] 10.3 将缓存失效挂钩到媒体删除
    - 删除项目时调用 invalidationService.onMediaDelete(ids)
    - 失效后刷新 UI
    - _需求: 6.3, 6.5_

  - [ ] 10.4 添加手动清除缓存按钮（可选）
    - 为清除缓存添加 UI 按钮
    - 调用 invalidationService.onManualClear()
    - 显示确认和成功消息
    - _需求: 6.4, 6.5_

- [ ] 11. 添加缓存状态的 UI 指示器
  - [ ] 11.1 网络不可用时显示离线指示器
    - 离线时显示横幅或图标
    - 指示数据可能过期
    - _需求: 7.4_

  - [ ] 11.2 在开发工具中显示缓存状态（可选）
    - 在控制台或 UI 中显示缓存统计
    - 显示命中率和条目数
    - _需求: 8.3, 8.5_

- [ ] 12. 测试和验证
  - [ ] 12.1 为缓存键生成编写单元测试
    - 测试相同请求生成相同的键
    - 测试不同参数生成不同的键
    - 测试参数规范化
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ] 12.2 为过期检查编写单元测试
    - 测试新鲜条目返回缓存数据
    - 测试过期条目触发刷新
    - 测试自定义阈值
    - _需求: 5.2, 5.3, 5.4, 5.5_

  - [ ] 12.3 为请求去重编写单元测试
    - 测试并发请求共享单个网络调用
    - 测试已完成请求从跟踪中清除
    - 测试错误处理
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ] 12.4 为缓存工作流编写集成测试
    - 测试缓存未命中 → 网络 → 缓存更新
    - 测试缓存命中 → 返回缓存数据
    - 测试离线模式返回过期数据
    - _需求: 3.5, 3.6, 7.1, 7.2_

  - [ ] 12.5 为失效编写集成测试
    - 测试重新索引使正确的缓存失效
    - 测试配置更新使配置缓存失效
    - 测试媒体删除使资源缓存失效
    - _需求: 6.1, 6.2, 6.3_

  - [ ] 12.6 测试 worker 中的 IndexedDB 操作
    - 测试数据库初始化
    - 测试 CRUD 操作
    - 测试配额管理
    - 测试版本迁移
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 10.2, 10.3, 10.4_

- [ ] 13. 检查点 - 确保所有测试通过且缓存系统功能正常
  - 验证缓存减少了网络请求
  - 验证离线模式正常工作
  - 验证失效触发器正常工作
  - 确保所有测试通过，如有问题请询问用户。

## 注意事项

- 每个任务都引用了具体的需求以便追溯
- 实施遵循自下而上的方法：基础设施 → worker → 管理器 → API 集成 → UI 集成
- 缓存版本控制允许未来的架构更改而不破坏现有缓存
- 请求去重防止并发请求期间的冗余网络调用
- 离线支持确保网络不可用时的优雅降级
- 所有测试任务都是必需的，以确保系统的全面质量保证
